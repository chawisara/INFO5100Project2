<html>

<head>
<title>INFO 5100: Project 2 - Interactive Web Pages</title>
<link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">
<style>
	body {font-family: "Muli", sans-serif; }
	svg {border: solid #ccc 1px; }
	path { fill: #ccc; stroke: #888; }
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>

</head>

<body>
	<svg id="map" height="810" width="900"></svg><br><font size = "3">

	<script>
		var svg = d3.select("#map");
		var projection;
		var mapData;
		var imgData, weatherTimeData, statsData;

		var width=900;
		var height=900;

		d3.json("nyc.json", function(json){

			projection = d3.geoMercator().fitExtent([[0, 10], [880, 800]], json)
			var pathGenerator = d3.geoPath().projection(projection);

			svg.selectAll("path")
			.data(json.features)
			.enter()
			.append("path")
			.attr("d", pathGenerator);

		});

		var parseRowImg = function(line) {
			return{
				PokemonNo: Number(line["Pokemon No."]),
				Name: line["Name"],
				ImgURL: line["Image URL"],
			}
		};

		var parseRowWeatherTime = function(line) {
			return{
				PokemonNo: Number(line["pokemonId"]),
				Latitude: Number(line["latitude"]),
				Longitude: Number(line["longitude"]),
				TimeOfDay: Number(line["appearedTimeOfDay"]),
				Hour: Number(line["appearedHour"]),
				Minute: Number(line["appearedMinute"]),
				City: line["city"],
				Weather: line["weather"],
				Population: Number(line["population_density"]),
			}
		};

		var parseRowStats = function(line) {
			return{
				PokemonNo: Number(line["#"]),
				Name: line["Name"],
				Type1: line["Type 1"],
				Type2: line["Type 2"],
				Total: Number(line["Total"]),
				HP: Number(line["HP"]),
				Attack: Number(line["Attack"]),
				Defense: Number(line["Defense"]),
				SpeedAtk: Number(line["Sp. Atk"]),
				SpeedDef: Number(line["Sp. Def"]),
				Speed: Number(line["Speed"]),
				Legendary: line["Legendary"],
			}
		};

		d3.queue()
		.defer(d3.csv, "pokemon-images.csv", parseRowImg)
		.defer(d3.csv, "pokemon-weather-time-nyc.csv", parseRowWeatherTime)
		.defer(d3.csv, "pokemon-stats.csv", parseRowStats)
		.await(function(error, imgdata, weatherdata, statsdata){
			imgData = imgdata;
			weatherTimeData = weatherdata;
			statsData = statsdata;
			showPokemon(imgData, weatherTimeData, statsData);
		});


		var dataPoints = function(imgdata, weatherdata, statsdata){
			var points = [];
			weatherdata.forEach(function(data){
				if(data.City=="New_York" && data.Latitude<42 && data.Latitude>39 && data.Longitude<-73 && data.Longitude>-74.1){
					var coordinate=[data.Longitude, data.Latitude];
					var timeOfDay=data.TimeOfDay;
					var hour=data.Hour;
					var minute=data.Minute;
					var weather=data.Weather;

					var totalPower, hp, atk, def;

					statsdata.forEach(function(stats){
						if(stats.PokemonNo==data.PokemonNo){
							totalPower=stats.Total;
							hp=stats.HP;
							atk=stats.Attack;
							def=stats.Defense;
							return true;
						}
					});

					var imgURL, name;
					imgData.forEach(function(img){
						if(img.PokemonNo==data.PokemonNo){
							imgURL=img.ImgURL;
							name=img.Name;
							return true;
						}
					});

					var point={pokemonNo: data.PokemonNo, name: name, imgURL: imgURL, coordinate: coordinate, timeOfDay: timeOfDay, hour: hour, minute: minute, weather: weather, total: totalPower, HP: hp, attack: atk, defense: def};

					points.push(point);
				}
			});

			return points;
		}

		function showPokemon(imgdata, weatherdata, statsdata) {

			var pokemons = dataPoints(imgdata, weatherdata, statsdata);

			pokemons.forEach(function (pokemon) {
				svg.append("image")
					.attr("x", projection(pokemon.coordinate)[0])
					.attr("y", projection(pokemon.coordinate)[1])
					.attr("height", 20)
					.attr("width", 20)
					.attr("href", pokemon.imgURL);
			});
		}
	</script>
</body>


</html>