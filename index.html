<html>

<head>
<title>INFO 5100: Project 2 - Interactive Web Pages</title>
<link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">
<style>
	body {font-family: "Muli", sans-serif; }
	svg {border: solid #ccc 1px; }
	path { fill: #ccc; stroke: #888; }
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>

</head>

<body>
	<svg id="map" height="810" width="900">
		<rect id="gym" x="740" y="650" height="150" width="150" style="fill:none; stroke-width:3; stroke:black"></div>
	</svg><br>
	<div id="buttons">
		<button id="clear"><img src="./weathericon/clear1x.png" style="width:128px;height:128px;"></button>
		<button id="cloudy"><img src="./weathericon/cloudy1x.png" style="width:128px;height:128px;"></button>
		<button id="drizzle"><img src="./weathericon/rain1x.png" style="width:128px;height:128px;"></button>
		<button id="breezy"><img src="./weathericon/snow1x.png" style="width:128px;height:128px;"></button>
	</div>

	<script>
		var svg = d3.select("#map");
		var projection;
		var mapData;
		var imgData, weatherTimeData, statsData;

		var width=900;
		var height=900;

		d3.json("nyc.json", function(json){

			projection = d3.geoMercator().fitExtent([[0, 10], [880, 800]], json)
			var pathGenerator = d3.geoPath().projection(projection);

			svg.selectAll("path")
			.data(json.features)
			.enter()
			.append("path")
			.attr("d", pathGenerator);

		});

		var parseRowImg = function(line) {
			return{
				PokemonNo: Number(line["Pokemon No."]),
				Name: line["Name"],
				ImgURL: line["Image URL"],
			}
		};

		var parseRowWeatherTime = function(line) {
			return{
				PokemonNo: Number(line["pokemonId"]),
				Latitude: Number(line["latitude"]),
				Longitude: Number(line["longitude"]),
				TimeOfDay: Number(line["appearedTimeOfDay"]),
				Hour: Number(line["appearedHour"]),
				Minute: Number(line["appearedMinute"]),
				City: line["city"],
				Weather: line["weather"],
				Population: Number(line["population_density"]),
			}
		};

		var parseRowStats = function(line) {
			return{
				PokemonNo: Number(line["#"]),
				Name: line["Name"],
				Type1: line["Type1"],
				Type2: line["Type2"],
				Total: Number(line["Total"]),
				HP: Number(line["HP"]),
				Attack: Number(line["Attack"]),
				Defense: Number(line["Defense"]),
				SpeedAtk: Number(line["Sp. Atk"]),
				SpeedDef: Number(line["Sp. Def"]),
				Speed: Number(line["Speed"]),
				Legendary: line["Legendary"],
			}
		};

		d3.queue()
		.defer(d3.csv, "pokemon-images.csv", parseRowImg)
		.defer(d3.csv, "pokemon-weather-time-nyc.csv", parseRowWeatherTime)
		.defer(d3.csv, "pokemon-stats.csv", parseRowStats)
		.await(function(error, imgdata, weatherdata, statsdata){
			imgData = imgdata;
			weatherTimeData = weatherdata;
			statsData = statsdata;
			showPokemon(imgData, weatherTimeData, statsData);
		});


		var dataPoints = function(imgdata, weatherdata, statsdata){
			var points = [];
			weatherdata.forEach(function(data){
				if(data.Latitude<42 && data.Latitude>39 && data.Longitude<-73 && data.Longitude>-74.1){
					var coordinate=[data.Longitude, data.Latitude];
					var timeOfDay=data.TimeOfDay;
					var hour=data.Hour;
					var minute=data.Minute;
					var weather=data.Weather;

					var totalPower, hp, atk, def;

					statsdata.forEach(function(stats){
						if(stats.PokemonNo==data.PokemonNo){
							totalPower=stats.Total;
							hp=stats.HP;
							atk=stats.Attack;
							def=stats.Defense;
							type1 = stats.Type1;
							type2 = stats.Type2;
							speed = stats.Speed;
							return true;
						}
					});

					var imgURL, name;
					imgData.forEach(function(img){
						if(img.PokemonNo==data.PokemonNo){
							imgURL=img.ImgURL;
							name=img.Name;
							return true;
						}
					});

					var point={pokemonNo: data.PokemonNo, name: name, imgURL: imgURL, coordinate: coordinate, timeOfDay: timeOfDay, hour: hour, minute: minute, weather: weather, speed: speed, total: totalPower, HP: hp, attack: atk, defense: def, type1: type1, type2:type2 };

					points.push(point);
				}
			});

			return points;
		}

		var pokemon1, pokemon2;
		var numpokemons=0;

		function showPokemon(imgdata, weatherdata, statsdata) {

			var pokemons = dataPoints(imgdata, weatherdata, statsdata);

			svg.selectAll("image")
			.data(pokemons)
			.enter().append("image")
			.attr("id", function(d){var latitude=d.coordinate[1].toString().replace(".", ""); return d.name+""+latitude;})
			.attr("class", function(d){return d.weather;})
			.attr("x", function(d){return projection(d.coordinate)[0];})
			.attr("y", function(d){return projection(d.coordinate)[1];})
			.attr("height", 20)
			.attr("width", 20)
			.attr("href", function(d){return d.imgURL;})
			.classed("draggable", "true")
			.attr("opacity", 0.6)
			.on("mouseover", function(d){
				this.setAttribute("opacity", 1.0);
				this.setAttribute("cursor", "pointer");
				showBio(d);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0.6);
				this.setAttribute("cursor", "default");
				hideBio(d);
			})
			.call(d3.drag()
				.on("start", dragstarted)
				.on("drag", dragged)
				.on("end", dragended));
		}

		function showBio(d){
			svg.append("rect")
			.attr("id","bio")
			.attr("x",200)
			.attr("y", 150)
			.attr("height", 200)
			.attr("width", 150)
			.attr("stroke","black")
			.attr("fill","white");

			svg.append("text")
			.attr("id","name")
			.attr("x",210)
			.attr("y",180)
			.text("Name: " + d.name);

			svg.append("text")
			.attr("id","type1")
			.attr("x",210)
			.attr("y",200)
			.text("Type1: " + d.type1);

			svg.append("text")
			.attr("id","type2")
			.attr("x",210)
			.attr("y",220)
			.text("Type2: " + d.type2);

			svg.append("text")
			.attr("id","attack")
			.attr("x",210)
			.attr("y",240)
			.text("Attack: " + d.attack);

			svg.append("text")
			.attr("id","defense")
			.attr("x",210)
			.attr("y",260)
			.text("Defense: " + d.defense);

			svg.append("text")
			.attr("id","speed")
			.attr("x",210)
			.attr("y",280)
			.text("speed: " + d.speed);

			svg.append("text")
			 .attr("id","total")
			 .attr("x",210)
			 .attr("y",300)
			 .text("Total Power: " + d.total);
		}

		function hideBio(d){
			d3.select("#bio").remove();
			d3.select("#name").remove();
			d3.select("#type1").remove();
			d3.select("#type2").remove();
			d3.select("#attack").remove();
			d3.select("#defense").remove();
			d3.select("#speed").remove();
			d3.select("#total").remove();
		}

		function clear_clicked(){
			svg.selectAll("image").style("opacity", 0);
			svg.selectAll(".Clear").style("opacity", 0.6);
		}
		function cloudy_clicked(){
			svg.selectAll("image").style("opacity", 0);
			svg.selectAll(".Overcast").style("opacity", 0.6);
		}
		function drizzle_clicked(){
			svg.selectAll("image").style("opacity", 0);
			svg.selectAll(".Drizzle").style("opacity", 0.6);
		}
		function breezy_clicked(){
			svg.selectAll("image").style("opacity", 0);
			svg.selectAll(".Breezy").style("opacity", 0.6);
		}

		d3.select("#clear").on("click", clear_clicked);
		d3.select("#cloudy").on("click", cloudy_clicked);
		d3.select("#drizzle").on("click", drizzle_clicked);
		d3.select("#breezy").on("click", breezy_clicked);

		//reference: https://bl.ocks.org/mbostock/22994cc97fefaeede0d861e6815a847e
		function dragstarted(d) {
			d3.select(this).raise().classed("active", true)
			d3.select("#gym").style("stroke", "red");
			d3.select(this).attr("opacity", 1);

			svg.append("rect")
			.attr("id","draghighlight")
			.attr("x", (width/2)-225-10)
			.attr("y", 20)
			.attr("rx", 20)
			.attr("ry", 20)
			.attr("height", 30)
			.attr("width", 470)
			.style("fill", "white")
			.style("stroke", "#dcdcdc")
			.style("opacity", 0.7);

			svg.append("text")
			.attr("id", "dragtext")
			.attr("x", width/2)
			.attr("y", 40)
			.style("text-anchor","middle")
			.style("font-family","Muli")
			.style("font-size", 16)
			.style("fill", "#3c3c3c")
			.text("drag two pokemons to the gym to compare their battle stats");
		}

		function dragged(d) {
			d3.select(this).attr("x", d3.event.x).attr("y", d3.event.y);
			d3.select(this).attr("opacity", 1);
		}

		function dragended(d) {
			d3.select(this).classed("active", false);
			d3.select("#gym").style("stroke", "black");
			hideBio(d);

			d3.select("#draghighlight").remove();
			d3.select("#dragtext").remove();

			if(!(d3.event.x>=740 && d3.event.y>=650)){
				if(pokemon1==d){
					numpokemons=0;
					pokemon1=null;
				}else if(pokemon2==d){
					numpokemons=1;
					pokemon2=null;
				}
				d3.select(this).attr("x", projection(d.coordinate)[0]).attr("y", projection(d.coordinate)[1]).attr("opacity", 0.6);
			}else{
				numpokemons++;
				if(numpokemons==1){
					pokemon1=d;
					d3.select(this).attr("opacity", 1);
				}else if(numpokemons==2){
					numpokemons=0;
					pokemon2=d;
					var latitude=pokemon1.coordinate[1].toString().replace(".", "");
					d3.select(this).attr("x", projection(d.coordinate)[0]).attr("y", projection(d.coordinate)[1]).attr("opacity", 0.6);
					d3.select("#"+pokemon1.name+""+latitude).attr("x", projection(pokemon1.coordinate)[0]).attr("y", projection(pokemon1.coordinate)[1]).attr("opacity", 0.6);
					showBattle(pokemon1, pokemon2);
				}
			}
		}

		function showBattle(pokemon1, pokemon2){
			svg.append("rect")
			.attr("id","tempbg")
			.attr("x", 0)
			.attr("y", 0)
			.attr("height", 810)
			.attr("width", 900)
			.style("fill", "white")
			.style("opacity", 0.5);

			svg.append("image")
			.attr("id", "pokemon1")
			.attr("x", 200)
			.attr("y", 300)
			.attr("height", 220)
			.attr("width", 200)
			.attr("href", function(d){return pokemon1.imgURL;});

			svg.append("image")
			.attr("id", "pokemon2")
			.attr("x", 500)
			.attr("y", 300)
			.attr("height", 220)
			.attr("width", 200)
			.attr("href", function(d){return pokemon2.imgURL;});

			svg.append("text")
			.attr("id", "vs")
			.attr("x", width/2)
			.attr("y", height/2)
			.style("text-anchor","middle")
			.style("font-family","Muli")
			.style("font-size", 30)
			.text("VS");

			svg.append("text")
			.attr("id", "close")
			.attr("x", width/2)
			.attr("y", (height/2)+200)
			.style("text-anchor","middle")
			.style("font-family","Muli")
			.style("font-size", 20)
			.text("[ close ]")
			.on("mouseover", function(){
				this.setAttribute("cursor", "pointer");
			})
			.on("click", removePopup);
		}

		function removePopup(){
			d3.select("#tempbg").remove();
			d3.select("#pokemon1").remove();
			d3.select("#pokemon2").remove();
			d3.select("#vs").remove();
			d3.select("#close").remove();
		}


	</script>
</body>


</html>