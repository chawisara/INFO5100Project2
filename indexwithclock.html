<html>

<head>
<title>INFO 5100: Project 2 - Interactive Web Pages</title>
<link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">
<style>
	body {font-family: "Muli", sans-serif; }
	svg {border: solid #ccc 1px; }
	path { fill: #ccc; stroke: #888; }

	line.axis { stroke: #ddd; }
	line#v1 { fill: none; stroke: #e41a1c; marker-end: url(#redarrow); }
	line#v2 { fill: none; stroke: #377eb8; marker-end: url(#bluearrow); }
	line.random { fill: none; stroke: #f59322; opacity: 0.3; }
	.red { stroke: #e41a1c; fill: #e41a1c; }
	.blue { stroke: #377eb8; fill: #377eb8; }
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>

</head>

<body>
	<svg id="map" height="810" width="900"></svg><br><font size = "3">
 <button id="morning">Morning</button>
  <button id="afternoon">Afternoon</button>
	<button id="evening">Everning</button>
	<button id="night">Night</button>
	<div id="plot">
		<svg id="clock" height="200" width="200">
			<defs>
				<!-- Inspired by http://bl.ocks.org/tomgp/d59de83f771ca2b6f1d4 -->
			<marker id="redarrow" viewBox="0 -5 10 10" refX="5" refY="0"
				markerWidth="4" markerHeight="4" orient="auto">
				<path d="M0,-5L10,0,L0,5" class="arrowHead red"/>
			</marker>
			<marker id="bluearrow" viewBox="0 -5 10 10" refX="5" refY="0"
				markerWidth="4" markerHeight="4" orient="auto">
				<path d="M0,-5L10,0,L0,5" class="arrowHead blue"/>
			</marker>
			</defs>
		</svg>
	</div>

	<script>
		var svg = d3.select("#map");
		var projection;
		var mapData;
		var imgData, weatherTimeData, statsData;

		var width=900;
		var height=900;

		d3.json("nyc.json", function(json){

			projection = d3.geoMercator().fitExtent([[0, 10], [880, 800]], json)
			var pathGenerator = d3.geoPath().projection(projection);

			svg.selectAll("path")
			.data(json.features)
			.enter()
			.append("path")
			.attr("d", pathGenerator);

		});

		var parseRowImg = function(line) {
			return{
				PokemonNo: Number(line["Pokemon No."]),
				Name: line["Name"],
				ImgURL: line["Image URL"],
			}
		};

		var parseRowWeatherTime = function(line) {
			return{
				PokemonNo: Number(line["pokemonId"]),
				Latitude: Number(line["latitude"]),
				Longitude: Number(line["longitude"]),
				TimeOfDay: line["appearedTimeOfDay"],
				Hour: Number(line["appearedHour"]),
				Minute: Number(line["appearedMinute"]),
				City: line["city"],
				Weather: line["weather"],
				Population: Number(line["population_density"]),
			}
		};

		var parseRowStats = function(line) {
			return{
				PokemonNo: Number(line["#"]),
				Name: line["Name"],
				Type1: line["Type1"],
				Type2: line["Type2"],
				Total: Number(line["Total"]),
				HP: Number(line["HP"]),
				Attack: Number(line["Attack"]),
				Defense: Number(line["Defense"]),
				SpeedAtk: Number(line["Sp. Atk"]),
				SpeedDef: Number(line["Sp. Def"]),
				Speed: Number(line["Speed"]),
				Legendary: line["Legendary"],
			}
		};

		d3.queue()
		.defer(d3.csv, "pokemon-images.csv", parseRowImg)
		.defer(d3.csv, "pokemon-weather-time-nyc.csv", parseRowWeatherTime)
		.defer(d3.csv, "pokemon-stats.csv", parseRowStats)
		.await(function(error, imgdata, weatherdata, statsdata){
			imgData = imgdata;
			weatherTimeData = weatherdata;
			statsData = statsdata;
			showPokemon(imgData, weatherTimeData, statsData);
		});


		var dataPoints = function(imgdata, weatherdata, statsdata){
			var points = [];
			weatherdata.forEach(function(data){
				if(data.City=="New_York" && data.Latitude<42 && data.Latitude>39 && data.Longitude<-73 && data.Longitude>-74.1){
					var coordinate=[data.Longitude, data.Latitude];
					var timeOfDay=data.TimeOfDay;
					var hour=data.Hour;
					var minute=data.Minute;
					var weather=data.Weather;

					var totalPower, hp, atk, def;

					statsdata.forEach(function(stats){
						if(stats.PokemonNo==data.PokemonNo){
							totalPower=stats.Total;
							hp=stats.HP;
							atk=stats.Attack;
							def=stats.Defense;
							type1 = stats.Type1;
							type2 = stats.Type2;
							speed = stats.Speed;
							return true;
						}
					});

					var imgURL, name;
					imgData.forEach(function(img){
						if(img.PokemonNo==data.PokemonNo){
							imgURL=img.ImgURL;
							name=img.Name;
							return true;
						}
					});

					var point={pokemonNo: data.PokemonNo, name: name, imgURL: imgURL, coordinate: coordinate, timeOfDay: timeOfDay, hour: hour, minute: minute, weather: weather, speed: speed, total: totalPower, HP: hp, attack: atk, defense: def, type1: type1, type2:type2 };

					points.push(point);
				}
			});

			return points;
		}

		function showPokemon(imgdata, weatherdata, statsdata) {

			var pokemons = dataPoints(imgdata, weatherdata, statsdata);

			pokemons.forEach(function(pokemon) {
				svg.append("image")
				  .attr("class",pokemon.timeOfDay)
					.attr("x", projection(pokemon.coordinate)[0])
					.attr("y", projection(pokemon.coordinate)[1])
					.attr("height", 20)
					.attr("width", 20)
					.attr("href", pokemon.imgURL)
					.on("mouseover", showBio)
					.on("mouseout", hideBio);


					function morning_clicked(){
			        svg.selectAll("image").style("opacity", 0);
			        svg.selectAll(".morning").style("opacity", 1);
			    }
			    function afternoon_clicked(){
			        svg.selectAll("image").style("opacity", 0);
			        svg.selectAll(".afternoon").style("opacity", 1);
			    }
			    function evening_clicked(){
			        svg.selectAll("image").style("opacity", 0);
			        svg.selectAll(".evening").style("opacity", 1);
			    }
				function night_clicked(){
			        svg.selectAll("image").style("opacity", 0);
			        svg.selectAll(".night").style("opacity", 1);
			    }

			     d3.select("#morning").on("click", morning_clicked);
			     d3.select("#afternoon").on("click", afternoon_clicked);
			     d3.select("#evening").on("click", evening_clicked);
			     d3.select("#night").on("click", night_clicked);




			 function showBio(){
		        svg.append("rect")
						   .attr("id","bio")
						   .attr("x",200)
							 .attr("y", 150)
							 .attr("height", 200)
		 					 .attr("width", 150)
							 .attr("stroke","black")
							 .attr("fill","white");
					 svg.append("text")
					    .attr("id","name")
							.attr("x",210)
							.attr("y",180)
							.text("Name: " + pokemon.name)
					 svg.append("text")
						  .attr("id","type1")
						  .attr("x",210)
						  .attr("y",200)
						  .text("Type1: " + pokemon.type1)
				   svg.append("text")
			 			  .attr("id","type2")
			 			  .attr("x",210)
			 				.attr("y",220)
			 				.text("Type2: " + pokemon.type2)
					svg.append("text")
							.attr("id","attack")
							.attr("x",210)
							.attr("y",240)
							.text("Attack: " + pokemon.attack)
					 svg.append("text")
				 		  .attr("id","defense")
				 			.attr("x",210)
				 			.attr("y",260)
				 			.text("Defense: " + pokemon.defense)
					 svg.append("text")
			 				.attr("id","speed")
			 				.attr("x",210)
			 				.attr("y",280)
			 				.text("speed: " + pokemon.speed)
					 svg.append("text")
								 .attr("id","total")
								 .attr("x",210)
								 .attr("y",300)
								 .text("totalPower: " + pokemon.total)
			}

			function hideBio(){
          d3.select("#bio").remove();
					d3.select("#name").remove();
					d3.select("#type1").remove();
					d3.select("#type2").remove();
					d3.select("#attack").remove();
					d3.select("#defense").remove();
					d3.select("#speed").remove();
				  d3.select("#total").remove();
			}

		})

		}


		var clockheight = 200;
		var clockwidth = 200;
		var clockpadding = 50;

		var mouseDown = false;

		var svgclock = d3.select("#clock").attr("height", clockheight).attr("width", clockwidth);
		var xScale = d3.scaleLinear().domain([-1.6, 1.6]).range([0, clockwidth]);
		var yScale = d3.scaleLinear().domain([-1.6, 1.6]).range([clockheight, 0]);

		// Background elements
		svgclock.append("circle")
		.attr("cx", xScale(0))
		.attr("cy", yScale(0))
		.attr("r", xScale(1.0) - xScale(0.0))
		.style("fill", "f0f0f0");


		var dataVectors = [normalize([0, 1]), normalize([1, 0])];

		var v1 = svgclock.append("line").attr("class", "arrow").attr("id", "v1")
		.style("stroke", "#e41a1c")
		.attr("x1", xScale(0))
		.attr("y1", yScale(0))
		.attr("x2", xScale(dataVectors[0][0]))
		.attr("y2", yScale(dataVectors[0][1]));

		var v2 = svgclock.append("line").attr("class", "arrow").attr("id", "v2")
		.style("stroke", "#377eb8")
		.attr("x1", xScale(0))
		.attr("y1", yScale(0))
		.attr("x2", xScale(dataVectors[1][0]))
		.attr("y2", yScale(dataVectors[1][1]));

		var randomVectors = [];

		var formatter = d3.format(".3f");
		var cosineText = svgclock.append("text")
		.attr("x", 10)
		.attr("y", 30)
		.text("time:" + formatter(innerProduct(dataVectors[0], dataVectors[1])));

		function innerProduct(x, y) {
			if (x.length != y.length) { console.log("vectors are not the same length"); }
			var sum = 0.0;
			for (var i = 0; i < x.length; i++) {
				sum += x[i] * y[i]
			}
			return sum;
		}

		function normalize(vector) {
			var length = Math.sqrt(d3.sum(vector, function (x) { return x * x; }));
			return vector.map(function (x) { return x / length; });
		}

		function updateDisplay() {
			v1
			.attr("x2", xScale(dataVectors[0][0]))
			.attr("y2", yScale(dataVectors[0][1]));

			v2
			.attr("x2", xScale(dataVectors[1][0]))
			.attr("y2", yScale(dataVectors[1][1]));

			cosineText
			.text("time: " + formatter(innerProduct(dataVectors[0], dataVectors[1])));

		}

		// User interaction events

		svgclock.on("mousedown", function () {
			var pixels = d3.mouse(this);
			var vector = normalize([xScale.invert(pixels[0]), yScale.invert(pixels[1])]);
		  dataVectors[0] = vector;

			mouseDown = true;
			updateDisplay();
		});

		svgclock.on("mousemove", function () {
			if (! mouseDown) { return; }
			var pixels = d3.mouse(this);
			var vector = normalize([xScale.invert(pixels[0]), yScale.invert(pixels[1])]);
		    dataVectors[1] = normalize(vector);

			updateDisplay();
		});

		svgclock.on("mouseup", function () {
			mouseDown = false;
		});




	</script>
</body>


</html>
